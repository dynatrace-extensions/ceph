name: custom:com.dynatrace.extension.ceph-cluster
version: 0.1.0
minDynatraceVersion: '1.230'
author:
  name: Dynatrace
dashboards:
- path: dashboards/ceph-default.json
metrics:
- key: com.dynatrace.extension.ceph-cluster.monitor.sessions.open
  metadata:
    displayName: Monitor Sessions
    description: Number of open monitor sessions
    unit: Count
- key: com.dynatrace.extension.ceph-cluster.monitor.quorum
  metadata:
    displayName: Quorum
    description: Monitor daemons in quorum
    unit: Count
- key: com.dynatrace.extension.ceph-cluster.capacity.total.bytes
  metadata:
    displayName: Total Capacity
    description: Total cluster capacity in bytes
    unit: Byte
- key: com.dynatrace.extension.ceph-cluster.capacity.used.bytes
  metadata:
    displayName: Used Capacity
    description: Used cluster capacity in bytes
    unit: Byte
- key: func:com.dynatrace.extension.ceph-cluster.capacity.used.percent
  query:
    metricSelector: (100) * (com.dynatrace.extension.ceph-cluster.capacity.used.bytes)
      / (com.dynatrace.extension.ceph-cluster.capacity.total.bytes)
  metadata:
    displayName: Capacity Usage %
    description: Percentage of total cluster capacity used
    unit: Percent
- key: com.dynatrace.extension.ceph-cluster.osd.in
  metadata:
    displayName: OSDs IN
    description: Storage daemons in the cluster
    unit: Count
- key: com.dynatrace.extension.ceph-cluster.osd.up
  metadata:
    displayName: OSDs UP
    description: Storage daemons running
    unit: Count
- key: com.dynatrace.extension.ceph-cluster.osd.write.bytes.total
  metadata:
    displayName: Bytes Written
    description: Total sum of bytes written to OSD
    unit: Byte
- key: com.dynatrace.extension.ceph-cluster.osd.read.bytes.total
  metadata:
    displayName: Bytes Read
    description: Total sum of bytes read from OSD
    unit: Byte
- key: com.dynatrace.extension.ceph-cluster.osd.write.operations.total
  metadata:
    displayName: Write Operations
    description: Total sum of write operations performed on OSD
    unit: Count
- key: com.dynatrace.extension.ceph-cluster.osd.read.operations.total
  metadata:
    displayName: Read Operations
    description: Total sum of read operation performed on OSD
    unit: Count
- key: com.dynatrace.extension.ceph-cluster.osd.apply.latency.ms
  metadata:
    displayName: OSD Apply Latency
    description: Latency of the "commit" operation on the OSD in milliseconds
    unit: MilliSecond
- key: com.dynatrace.extension.ceph-cluster.osd.commit.latency.ms
  metadata:
    displayName: OSD Commit Latency
    description: Latency of the "commit" operation on the OSD in milliseconds
    unit: MilliSecond
- key: com.dynatrace.extension.ceph-cluster.osd.write.latency.total.ms
  metadata:
    displayName: Total OSD Write Latency
    description: Total latency of the "write" operations on the OSD in milliseconds
    unit: MilliSecond
- key: com.dynatrace.extension.ceph-cluster.osd.read.latency.total.ms
  metadata:
    displayName: Total OSD Read Latency
    description: Total latency of the "read" operations on the OSD in milliseconds
    unit: MilliSecond
- key: func:com.dynatrace.extension.ceph-cluster.osd.write.latency.avg.ms
  query:
    metricSelector: (com.dynatrace.extension.ceph-cluster.osd.write.latency.total.ms)
      / (com.dynatrace.extension.ceph-cluster.osd.write.operations.total)
  metadata:
    displayName: Average OSD Write Latency
    description: Average latency per "write" operation on the OSD in milliseconds
    unit: MilliSecond
- key: func:com.dynatrace.extension.ceph-cluster.osd.read.latency.avg.ms
  query:
    metricSelector: (com.dynatrace.extension.ceph-cluster.osd.read.latency.total.ms)
      / (com.dynatrace.extension.ceph-cluster.osd.read.operations.total)
  metadata:
    displayName: Average OSD Read Latency
    description: Average latency per "read" operation on the OSD in milliseconds
    unit: MilliSecond
- key: com.dynatrace.extension.ceph-cluster.osd.numpg
  metadata:
    displayName: Placement groups
    description: Placement groups
    unit: Count
- key: com.dynatrace.extension.ceph-cluster.pool.objects
  metadata:
    displayName: Objects Count
    description: Number of objects in pool
    unit: Count
- key: com.dynatrace.extension.ceph-cluster.pool.objects.recovered
  metadata:
    displayName: Objects Recovered
    description: Number of recovered objects in pool
    unit: Count
- key: com.dynatrace.extension.ceph-cluster.pool.bytes.recovered
  metadata:
    displayName: Bytes Recovered
    description: Number of recovered bytes in pool
    unit: Byte
- key: com.dynatrace.extension.ceph-cluster.pool.recovery.operations
  metadata:
    displayName: Recovery Operations
    description: Number of recovery operations in OSD
    unit: Count
- key: com.dynatrace.extension.ceph-cluster.pool.objects.quota
  metadata:
    displayName: Pool Objects Quota
    description: Object quota set for pool
    unit: Count
- key: com.dynatrace.extension.ceph-cluster.pool.bytes.quota
  metadata:
    displayName: Pool Bytes Quota
    description: Byte quota set for pool
    unit: Count
- key: com.dynatrace.extension.ceph-cluster.monitor.metadata
  metadata:
    displayName: Monitor Metadata
    description: Placeholder metric to get monitor metadata dimensions from exporter
    unit: Count
prometheus:
- group: cluster
  interval: 1m
  subgroups:
  - subgroup: monitor
    metrics:
    - key: com.dynatrace.extension.ceph-cluster.monitor.sessions.open
      type: gauge
      value: metric:ceph_mon_num_sessions
    - key: com.dynatrace.extension.ceph-cluster.monitor.quorum
      type: gauge
      value: metric:ceph_mon_quorum_status
    dimensions:
    - key: mon.name
      value: label:ceph_daemon
      filter: const:$prefix(mon.)
  - subgroup: general
    metrics:
    - key: com.dynatrace.extension.ceph-cluster.capacity.total.bytes
      type: gauge
      value: metric:ceph_cluster_total_bytes
    - key: com.dynatrace.extension.ceph-cluster.capacity.used.bytes
      type: gauge
      value: metric:ceph_cluster_total_used_bytes
  - subgroup: osd
    metrics:
    - key: com.dynatrace.extension.ceph-cluster.osd.in
      type: gauge
      value: metric:ceph_osd_in
    - key: com.dynatrace.extension.ceph-cluster.osd.up
      type: gauge
      value: metric:ceph_osd_up
    - key: com.dynatrace.extension.ceph-cluster.osd.write.bytes.total
      type: count
      value: metric:ceph_osd_op_w_in_bytes
    - key: com.dynatrace.extension.ceph-cluster.osd.read.bytes.total
      type: count
      value: metric:ceph_osd_op_r_out_bytes
    - key: com.dynatrace.extension.ceph-cluster.osd.write.operations.total
      type: count
      value: metric:ceph_osd_op_w
    - key: com.dynatrace.extension.ceph-cluster.osd.read.operations.total
      type: count
      value: metric:ceph_osd_op_r
    - key: com.dynatrace.extension.ceph-cluster.osd.apply.latency.ms
      type: gauge
      value: metric:ceph_osd_apply_latency_ms
    - key: com.dynatrace.extension.ceph-cluster.osd.commit.latency.ms
      type: gauge
      value: metric:ceph_osd_commit_latency_ms
    - key: com.dynatrace.extension.ceph-cluster.osd.write.latency.total.ms
      type: count
      value: metric:ceph_osd_op_w_latency_sum
    - key: com.dynatrace.extension.ceph-cluster.osd.read.latency.total.ms
      type: count
      value: metric:ceph_osd_op_r_latency_sum
    - key: com.dynatrace.extension.ceph-cluster.pool.recovery.operations
      type: count
      value: metric:ceph_osd_recovery_ops
    - key: com.dynatrace.extension.ceph-cluster.osd.numpg
      type: gauge
      value: metric:ceph_osd_numpg
    dimensions:
    - key: osd.name
      value: label:ceph_daemon
      filter: const:$prefix(osd.)
  - subgroup: pool
    metrics:
    - key: com.dynatrace.extension.ceph-cluster.pool.objects
      type: gauge
      value: metric:ceph_pool_objects
    - key: com.dynatrace.extension.ceph-cluster.pool.objects.recovered
      type: gauge
      value: metric:ceph_pool_num_objects_recovered
    - key: com.dynatrace.extension.ceph-cluster.pool.bytes.recovered
      type: gauge
      value: metric:ceph_pool_num_bytes_recovered
    - key: com.dynatrace.extension.ceph-cluster.pool.objects.quota
      type: gauge
      value: metric:ceph_pool_quota_objects
    - key: com.dynatrace.extension.ceph-cluster.pool.bytes.quota
      type: gauge
      value: metric:ceph_pool_quota_bytes
  - subgroup: metadata
    metrics:
    - key: com.dynatrace.extension.ceph-cluster.monitor.metadata
      type: gauge
      value: metric:ceph_mon_metadata
topology:
  types:
  - name: ceph-cluster:cluster
    displayName: Ceph Cluster
    enabled: true
    rules:
    - idPattern: ceph_cluster_{device.name}
      instanceNamePattern: Ceph Cluster {device.name}
      sources:
      - sourceType: Metrics
        condition: $prefix(com.dynatrace.extension.ceph-cluster)
      requiredDimensions: []
      attributes:
        - key: deviceAddress
          displayName: Device Address
          pattern: "{device.address}"
        - key: devicePort
          displayName: Device Port
          pattern: "{device.port}"
        - key: deviceName
          displayName: Device Name
          pattern: "{device.name}"
  - name: ceph-cluster:monitor
    displayName: Ceph Monitor
    enabled: true
    rules:
    - idPattern: ceph_monitor_{mon.name}
      sources:
      - sourceType: Metrics
        condition: $prefix(com.dynatrace.extension.ceph-cluster.monitor)
      attributes: []
      requiredDimensions: []
      instanceNamePattern: Ceph Monitor Daemon {mon.name}
  - name: ceph-cluster:osd
    displayName: Ceph OSD
    enabled: true
    rules:
    - idPattern: ceph_osd_{osd.name}
      sources:
      - sourceType: Metrics
        condition: $prefix(com.dynatrace.extension.ceph-cluster.osd)
      attributes: []
      requiredDimensions: []
      instanceNamePattern: Ceph Storage Daemon {osd.name}
  relationships:
    - sources:
      - sourceType: Metrics
        condition: "$prefix(com.dynatrace.extension.ceph-cluster.monitor)"
      fromType: "ceph-cluster:monitor"
      toType: "ceph-cluster:cluster"
      typeOfRelation: "CHILD_OF"
    - sources:
      - sourceType: Metrics
        condition: "$prefix(com.dynatrace.extension.ceph-cluster.osd)"
      fromType: "ceph-cluster:osd"
      toType: "ceph-cluster:cluster"
      typeOfRelation: "CHILD_OF"
screens:
  - entityType: ceph-cluster:cluster
    listSettings:
      staticContent:
        showGlobalFilter: true
        header:
          title: "Ceph Cluster"
          description: "Overview of all Clusters in Ceph"
          icon: ceph
      layout:
        autoGenerate: false
        cards:
          - key: cluster-list
            type: ENTITIES_LIST
    propertiesCard:
      displayOnlyConfigured: true
      properties:
        - type: ATTRIBUTE
          attribute:
            key: deviceName
            displayName: Device Name
        - type: ATTRIBUTE
          attribute:
            key: deviceAddress
            displayName: Device Address
        - type: ATTRIBUTE
          attribute:
            key: devicePort
            displayName: Device Port
    detailsSettings:
      staticContent:
        breadcrumbs:
          - type: ENTITY_LIST_REF
            entityType: ceph-cluster:cluster
        showProblems: true
        showProperties: true
        showAddTag: true
        showTags: true
        showGlobalFilter: true
      layout:
        autoGenerate: false
        cards:
          - key: "ceph-cluster"
            type: "CHART_GROUP"
          - key: "ceph-cluster-monitor-list"
            type: "ENTITIES_LIST"
          - key: "ceph-cluster-osd-list"
            type: "ENTITIES_LIST"
    chartsCards:
      - key: "ceph-cluster"
        displayName: "Cluster metrics"
        numberOfVisibleCharts: 2
        charts:
          - displayName: "Total Capacity"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.capacity.total.bytes:splitBy()"
          - displayName: "Used Capacity"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.capacity.used.bytes:splitBy()"
          - displayName: "Capacity Usage %"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "func:com.dynatrace.extension.ceph-cluster.capacity.used.percent:splitBy()"
    entitiesListCards:
      - key: cluster-list
        displayName: "Cluster list"
        pageSize: 5
        displayCharts: false
        displayIcons: true
        enableDetailsExpandability: true
        numberOfVisibleCharts: 2
      - key: ceph-cluster-monitor-list
        displayName: "Monitor"
        entitySelectorTemplate: "type(ceph-cluster:monitor),fromRelationships.isChildOf($(entityConditions))"
        pageSize: 5
        displayCharts: true
        displayIcons: true
        enableDetailsExpandability: true
        numberOfVisibleCharts: 3
        charts:
          - displayName: "Monitor Sessions"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.monitor.sessions.open"
          - displayName: "Quorum"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.monitor.quorum"
      - key: ceph-cluster-osd-list
        displayName: "OSD"
        entitySelectorTemplate: "type(ceph-cluster:osd),fromRelationships.isChildOf($(entityConditions))"
        pageSize: 5
        displayCharts: true
        displayIcons: true
        enableDetailsExpandability: true
        numberOfVisibleCharts: 3
        charts:
          - displayName: "OSDs IN"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.osd.in"
          - displayName: "OSDs UP"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.osd.up"
          - displayName: "Bytes Write/Read"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.osd.write.bytes.total"
              - metricSelector: "com.dynatrace.extension.ceph-cluster.osd.read.bytes.total"
          - displayName: "Operations Write/Read"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.osd.write.operations.total"
              - metricSelector: "com.dynatrace.extension.ceph-cluster.osd.read.operations.total"
          - displayName: "OSD Latency"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.osd.apply.latency.ms"
              - metricSelector: "com.dynatrace.extension.ceph-cluster.osd.commit.latency.ms"
              - metricSelector: "com.dynatrace.extension.ceph-cluster.osd.write.latency.total.ms"
              - metricSelector: "com.dynatrace.extension.ceph-cluster.osd.read.latency.total.ms"
          - displayName: "Recovery Operations"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.pool.recovery.operations"
          - displayName: "Placement groups"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.osd.numpg"
  - entityType: ceph-cluster:monitor
    listSettings:
      staticContent:
        showGlobalFilter: true
        header:
          title: "Monitor"
          description: "Overview of all Monitors in Ceph"
          icon: ceph
      layout:
        autoGenerate: false
        cards: []
#          - key: cluster-list
#            type: ENTITIES_LIST
    propertiesCard:
      displayOnlyConfigured: true
      properties: []
#        - type: ATTRIBUTE
#          attribute:
#            key: backend
#            displayName: Backend
    detailsSettings:
      staticContent:
        breadcrumbs:
          - type: ENTITY_LIST_REF
            entityType: ceph-cluster:monitor
        showProblems: true
        showProperties: true
        showAddTag: true
        showTags: true
        showGlobalFilter: true
      layout:
        autoGenerate: false
        cards:
          - key: "ceph-monitor"
            type: "CHART_GROUP"
    chartsCards:
      - key: "ceph-monitor"
        displayName: "Monitor"
        numberOfVisibleCharts: 2
        charts:
          - displayName: "Sessions"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.monitor.sessions.open:splitBy()"
          - displayName: "Quorum"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.monitor.quorum:splitBy()"
  - entityType: ceph-cluster:osd
    listSettings:
      staticContent:
        showGlobalFilter: true
        header:
          title: "OSD"
          description: "Overview of all OSDs in Ceph"
          icon: ceph
      layout:
        autoGenerate: false
        cards: []
    propertiesCard:
      displayOnlyConfigured: true
      properties: []
    detailsSettings:
      staticContent:
        breadcrumbs:
          - type: ENTITY_LIST_REF
            entityType: ceph-cluster:osd
        showProblems: true
        showProperties: true
        showAddTag: true
        showTags: true
        showGlobalFilter: true
      layout:
        autoGenerate: false
        cards:
          - key: "ceph-osd"
            type: "CHART_GROUP"
          - key: "ceph-bytes"
            type: "CHART_GROUP"
          - key: "ceph-operations"
            type: "CHART_GROUP"
          - key: "ceph-latency"
            type: "CHART_GROUP"
          - key: "ceph-recovery"
            type: "CHART_GROUP"
          - key: "ceph-placement"
            type: "CHART_GROUP"
    chartsCards:
      - key: "ceph-osd"
        displayName: "Monitor"
        numberOfVisibleCharts: 2
        charts:
          - displayName: "OSDs IN"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.osd.in"
          - displayName: "OSDs UP"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.osd.up"
      - key: "ceph-bytes"
        displayName: "Bytes"
        numberOfVisibleCharts: 2
        charts:
          - displayName: "Bytes Write"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.osd.write.bytes.total"
          - displayName: "Bytes Read"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.osd.write.bytes.total"
      - key: "ceph-operations"
        displayName: "Operations"
        numberOfVisibleCharts: 2
        charts:
          - displayName: "Operations Write"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.osd.write.operations.total"
          - displayName: "Operations Read"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.osd.read.operations.total"
      - key: "ceph-latency"
        displayName: "Latency"
        numberOfVisibleCharts: 4
        charts:
          - displayName: "Apply"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.osd.apply.latency.ms"
          - displayName: "Commit"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.osd.commit.latency.ms"
          - displayName: "Write"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.osd.write.latency.total.ms"
          - displayName: "Read"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.osd.read.latency.total.ms"
      - key: "ceph-recovery"
        displayName: "Recovery"
        numberOfVisibleCharts: 1
        charts:
          - displayName: "Recovery Operations"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.pool.recovery.operations"
      - key: "ceph-placement"
        displayName: "Placement"
        numberOfVisibleCharts: 1
        charts:
          - displayName: "Placement groups"
            visualization:
              themeColor: DEFAULT
              seriesType: LINE
            metrics:
              - metricSelector: "com.dynatrace.extension.ceph-cluster.osd.numpg"